<!-- CANVAS2D SHIM BELOW - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
<!doctype html>
<head>
  <title>StarTraveler</title>
  <meta name="author" content="Dietrich Epp"></meta>
  <meta name="description" content="An excursion to the stars"></meta>
  <meta name="title" content="Star Traveler"></meta>
  <meta charset=utf-8>
</head>
<body id=b>
<canvas id=a></canvas>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
#a { position: relative; display: block; } /* to be changed */
.play { position: fixed; top: 50%; left: 50%; transform: translateX(-50%)translateY(-50%); font-size: 30px; font-family: arial, sans-serif; background: #f3f4f5; padding: 15px; border: 2px solid #ddd; border-radius: 5px; }
</style>

<script>

// Entry configuration
// ===================

var title = "Star Traveler";

// Shim setup and polyfills (do not edit)
// ======================================

a.width = innerWidth; a.height = innerHeight;

c = a.getContext("2d"); // no more $type conditional

d = document;
window.AudioContext = window.AudioContext || window.webkitAudioContext;
window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
a.requestPointerLock = a.requestPointerLock || a.mozRequestPointerLock || a.webkitRequestPointerLock;
navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
if (typeof OscillatorNode !== 'undefined' && OscillatorNode.prototype) {
  OscillatorNode.prototype.start = OscillatorNode.prototype.start || OscillatorNode.prototype.noteOn;
  OscillatorNode.prototype.stop = OscillatorNode.prototype.stop || OscillatorNode.prototype.noteOff;
}

// Add a start button if sound is present in the code
onload = () => {
  var entry_code = entry.innerText;
  var has_sound = false;
  if(entry_code.includes('eval')){
    try {
      eval(entry_code.replace(/eval\(/g, 'throw(').replace(/eval\`/g, 'throw`'));
    }
    catch(e){
      entry_code = e;
    }
  }
  if(entry_code.includes("AudioContext")||entry_code.includes("Oscillator")||entry_code.includes("speak")||entry_code.includes("play")||entry_code.includes("autoplay")){
    b.insertAdjacentHTML("beforeEnd", "<button class='play' onclick='console.log(entry.innerText);eval(entry.innerText);this.remove()'>PLAY</button>");
  }
  else {
    eval(entry.innerText);
  }
};
console.log(
  a, // canvas
  b, // body
  c, // 2D canvas context
  d  // document
);

</script>

<script id=entry>
// Your entry goes here ðŸ‘‡
// =======================
// for(_='(a__,^2*K.5J/2I(eH()G0,Z(ZZY.2/Xe3,W(l=VJ)*(U-2T1,athtranslate(&&(c.0*d([...99),c.fill,111(se,t=i(3,l,=>,a.height)].flatG)))(c.save((restoreG)=new P2D(	.map(o(a.width^e)scale(M.randomG(h/4+U1.2-l)+.KAZZZh=0;i=Array_).keysG]e);s	"M-0Z-10Z1-0");n=^,l)t--?V_+e)I+(-Ut<5)*K*tI,[n^tn():[a];m=[i(5W^,h,n)([,h]a-Jna+150*iV5-a/1e3-M.log1p(9**(r-8>.001&&l<1*e/*t/lT6,-9),l*nJ,Jl*9i(6ZH	`MZL${nY10)[e,a]).join("L")}L1W`tV2-aI5-r/5)>.02Z46,9)T0T0Z-9)XXl-70Z20+l*l*803*r,145,o(K12o(rT,346,534,223,111,c.fillH.7*r-o(889,346K222,815,933112,334)globalAlpha=d(3J+T80*r,T52,-1H;o=^...l)_*=a>Z[]=l.slice_e=l.pop(e]aa==+a?""+a]a3Ka-32):aStyle=`rgb(${tl(1-a%1)*e[l]+a%1*t[l])})`,t);d=1/(1+3**H*_-r;f=eRectYII/,/h=h||eTWr=H-h)/3e3%1ZrequestAnimationFrame(fmaaZ145beginP(arcYX(10-rZ7;fG';G=/[-T-ZG-K^_]/.exec(_);)with(_.split(G))_=join(shift());eval(_)

// Demo title. This is stripped out of the demo by the build system, but it is
// present in the shim.
/* exported title */
var title = 'Star Traveler';

// Temporary variables.
let x, y, z;

// Timestamp of start of animation.
let zeroTime = 0;

// Current time, ranging from 0..10.
let time;

// Return an array 'a' with size 'i', where a[j] = x(j).
let iter = (i, x) => [...Array(i).keys()].map(x);

let star = new Path2D(
  'M-1,0A1,1,0,0,0,0,-1A1,1,0,0,0,1,0A1,1,0,0,0,0,1A1,1,0,0,0,-1,0',
);

let fractal = (x, y, i, z) =>
  i--
    ? ((z = (x + y) / 2 + ((Math.random() - 0.5) * (i < 5) * 2 ** i) / 2),
      [fractal(x, z, i), fractal(z, y, i)].flat())
    : [x];

// Generate 10 random mountain ranges.
let functions = [
  iter(5e3, (i, u, v, w, y) => {
    [u, v, w] = iter(3, (_) => Math.random() - 0.5);
    y = iter(3, (_) => 99 + 150 * Math.random());
    return (_) =>
      (z = 5 - i / 1e3 - Math.log1p(9 ** (time - 8))) > 1e-3 &&
      z < 1 &&
      (c.translate((u * 99) / z, (v * 99) / z - 20 * smooth(6, -9)),
      c.scale(
        (w / 4 + 0.5) * (1.2 - z) + 0.2 * Math.random(),
        (w / 4 + 0.5) * (1.2 - z) + 0.2 * Math.random(),
      ),
      color(z * z, y, 111),
      c.fill(star),
      c.scale(0.5, 0.5),
      color(z * z, 999, 111),
      c.fill(star));
  }),
  iter(60, (i, p) => {
    p = new Path2D(
      `M0,99L${fractal(0, 0, 10)
        .map((y, i) => [i, y])
        .join('L')}L1e3,99`,
    );
    return (_) =>
      // Z coordinate.
      (z = 2 - i / 25 - time / 5) > 0.02 &&
      // Camera movement.
      (c.translate(0, 40 * smooth(6, 9) - 20 - 200 * smooth(0, -9)),
      c.scale(0.2 / z, 0.2 / z),
      // The x*x*80 is a planetary curvature factor.
      c.translate(-700, 20 + z * z * 80),
      // Mountains
      // Mountains go from x=5..25
      color(
        time * 3,
        145,
        color(z * 2, 121, color(time - 2, 346, 534, 223, 111)),
      ),
      // COLORS:
      // - desert brown (night): 443 -> 223
      // - lunar surface (night): 444 -> 222
      // - forest (day): 121 -> 346
      // - forest (?): 121 445
      // - sunset: -> 445
      c.fill(p),
      // Clouds
      // Closest cloud is at z=11 or so, farthest at z=50 or so.
      color(
        time * 0.7 - 1,
        // color(z, 137, 346), // clear day
        color(z, 889, 346), // cloudy day
        color(z * 2, 222, 815, 933), // sunset
        color(z, 112, 334), // night
      ),
      (c.globalAlpha = smooth(3.5 + z, -2)),
      c.translate(time * 80, -25),
      c.scale(2, -1),
      c.fill(p));
  }),
].flat();

// Function to generate colors. Uses x, y. Assigns result to fillStyle and
// returns it as an array of RGB values in the range 0..255.
//
// This function generates a color from a linear gradient. The first parameter
// is the position along the gradient from 0 to N+1, the remaining parameters
// are N colors. The colors can either be [R,G,B] arrays with values in the
// range 0-255, or can be three-digit numbers with one digit for each channel.
// The digits may range from 1 to 9 (0 is not used).
//
// For example, the color black is either 111 or [0,0,0]. White is 999 or
// [255,255,255]. Red is 911 or [255,0,0].
//
// Usage examples:
//
//     color(x, 111, 999); // Gradient, x=0 is black, x=1 is white.
//     color(x, 911, 191, 119); // x=0 is red, x=1 is green, x=2 is blue
//     color(x, 111, color(y, 911, 119)); // Double gradient
let color = (a, ...b) => (
  (a *= a > 0),
  ([x, y] = [...b.slice(a), (x = b.pop()), x].map((y) =>
    y == +y ? [...('' + y)].map((y) => 32 * y - 32) : y,
  )),
  (c.fillStyle = `rgb(${(y = iter(
    3,
    (i) => (1 - (a % 1)) * x[i] + (a % 1) * y[i],
  ))})`),
  y
);

// Smooth step function. Starts with value 0, changes smoothly to value 1. Takes
// two paramaters, which are the transition time, and the
// transition speed, which is a positive number (24 is fast, 8 is slower). The
// transition starts slightly before the given time and finishes slightly after.
//
// For example, smooth(4, 24) changes from 0 to 1 at t=4.
let smooth = (x, y) => 1 / (1 + 3 ** (y * (x - time)));

// Frame rendering callback.
let render = (t) => (
  c.save(),
  c.fillRect(0, 0, a.width, a.height),
  c.translate(a.width / 2, a.height / 2),
  c.scale(a.width / 99, a.width / 99),
  (zeroTime = zeroTime || t - 2e3),
  (time = ((t - zeroTime) / 3e3) % 10),
  requestAnimationFrame(render),
  functions.map((x) => (c.save(), x(), c.restore())),
  color(0, 145),
  c.beginPath(),
  c.arc(0, 0, 0.2 / (10 - time), 0, 7),
  c.fill(),
  c.restore()
);

// Rendering callback will call requestAnimationFrame.
render();


// =======================
</script>
</body>
